{EventEmitter} = require \events

class Sock extends EventEmitter
  (@ws) ->
    ws.on \data @~message
    ws.on \close ~> @emit \drop

  message: ->
    try
      msg = JSON.parse it
    catch
      console.log 'error parsing message' it
      return
    @emit ...msg

  send: (name, args) ->
    @ws.write JSON.stringify { name, args }

module.exports = Sock
